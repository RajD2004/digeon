<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Admin Dashboard</title>
  <style>
    :root{
      --bg:#0f1216; --panel:#151a21; --muted:#9fb0c2; --text:#e6edf3;
      --brand:#19b6ad; --border:#273141; --accent:#0077cc; --danger:#e63946;
    }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .container{max-width:1100px;margin:28px auto;padding:0 22px}
    h1{margin:0 0 18px;color:var(--brand);font-size:28px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px} @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:#151a21;border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:18px}
    .card .body{padding:16px}
    label{font-size:13px;color:#cfe0f2;margin-bottom:6px;display:block}
    input,textarea,select{width:100%;background:#0d1219;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
    textarea{min-height:180px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn-outline{background:transparent;border:1px solid var(--border)}
    .btn-danger{background:var(--danger)}
    .help{font-size:12px;color:var(--muted)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    thead th{color:#cfe0f2;background:#1a2029}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:12px;color:#cfe0f2}
    .pill.published{border-color:#2b5e59;color:#86e9e3}
    .pill.draft{border-color:#41506b;color:#8fb2ff}
    fieldset{border:1px solid var(--border);border-radius:12px;padding:12px}
    legend{padding:0 6px;color:#00d1c4;font-weight:800}
    .cat-grid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px 16px}
    .toast{position:fixed;bottom:18px;right:18px;background:#0c1117;border:1px solid var(--border);color:#cfe0f2;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:60}
    .toast.show{opacity:1;transform:none}
    .preview{background:#12161c;border:1px solid var(--border);border-radius:12px;margin-top:10px}
    .preview .head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:10px 12px}
    .preview .body{padding:12px}
    .preview .tags{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Dashboard</h1>

    <div class="grid">
      <!-- NEWSLETTER -->
      <div class="card">
        <h2>Create / Edit Newsletter</h2>
        <div class="body">
          <div>
            <label for="nlSubject">Subject *</label>
            <input id="nlSubject" type="text" maxlength="120" placeholder="e.g., 7 AI tools that save 5+ hours/week" />
          </div>

          <div style="margin-top:10px">
            <label for="nlContent">Body *</label>
            <textarea id="nlContent" placeholder="Write your post here. Use {{name}} to personalize the greeting."></textarea>
          </div>

          <div class="row" style="align-items:center;margin-top:8px">
            <button class="btn btn-outline" id="nlInsertName" type="button">Insert {{name}}</button>
            <span class="help">Click to insert the {{name}} token where your cursor is.</span>
          </div>

          <fieldset style="margin-top:12px">
            <legend>Area of Interest</legend>
            <div id="nlCatGrid" class="cat-grid"></div>
          </fieldset>

          <div class="actions">
            <button class="btn btn-outline" id="nlClearBtn" type="button">Clear</button>
            <button class="btn" id="nlSaveDraftBtn" type="button">Save Draft</button>
            <button class="btn" id="nlPublishBtn" type="button">Publish</button>
          </div>

          <!-- Preview -->
          <div class="preview">
            <div class="head">
              <strong>Live Preview</strong>
              <span id="pvStatus" class="help">Draft not saved</span>
            </div>
            <div class="body">
              <p id="pvSubject" style="margin:0 0 6px;font-weight:800">[Subject will appear here]</p>
              <p id="pvGreet" style="margin:0 0 10px;color:#cfe0f2">Hi there,</p>
              <p id="pvContent" style="white-space:pre-wrap;margin:0;color:#e6edf3">Start writing your post body to see a preview…</p>
              <div id="pvTags" class="tags" style="margin-top:10px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- BLOG -->
      <div class="card">
        <h2>Write Blog</h2>
        <div class="body">
          <div>
            <label for="blTitle">Title *</label>
            <input id="blTitle" type="text" maxlength="120" placeholder="Post title" />
          </div>

          <div style="margin-top:10px">
            <label for="blContent">Content *</label>
            <textarea id="blContent" placeholder="Write your blog post…"></textarea>
          </div>

          <div style="margin-top:10px">
            <label for="blImage">Image (optional)</label>
            <input id="blImage" type="file" accept="image/*" />
            <div class="help">If provided, it will be uploaded with the post.</div>
          </div>

          <div class="actions">
            <button class="btn" id="blPublishBtn" type="button">Publish Blog</button>
          </div>
        </div>
      </div>
    </div>

    <!-- BLOG LIST -->
    <div class="card" style="margin-top:18px">
      <h2>All Blogs</h2>
      <div class="body table-wrap">
        <table>
          <thead>
            <tr><th>Title</th><th>Excerpt</th><th>Created</th></tr>
          </thead>
          <tbody id="blTbody"></tbody>
        </table>
        <div id="blEmpty" class="help" style="display:none;margin-top:8px">No blog posts yet.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Toast
    const toastEl = document.getElementById('toast'); let toastT=null;
    function toast(msg, isErr=false){
      toastEl.textContent = msg;
      toastEl.style.borderColor = isErr ? '#7b2b34' : '#2b5e59';
      toastEl.classList.add('show');
      clearTimeout(toastT); toastT=setTimeout(()=>toastEl.classList.remove('show'),2200);
    }

    // Newsletter DOM
    const nlSubject = document.getElementById('nlSubject');
    const nlContent = document.getElementById('nlContent');
    const nlInsertName = document.getElementById('nlInsertName');
    const nlCatGrid = document.getElementById('nlCatGrid');
    const nlClearBtn = document.getElementById('nlClearBtn');
    const nlSaveDraftBtn = document.getElementById('nlSaveDraftBtn');
    const nlPublishBtn = document.getElementById('nlPublishBtn');

    const pvSubject = document.getElementById('pvSubject');
    const pvGreet = document.getElementById('pvGreet');
    const pvContent = document.getElementById('pvContent');
    const pvTags = document.getElementById('pvTags');
    const pvStatus = document.getElementById('pvStatus');

    // Blog DOM
    const blTitle = document.getElementById('blTitle');
    const blContent = document.getElementById('blContent');
    const blImage = document.getElementById('blImage');
    const blPublishBtn = document.getElementById('blPublishBtn');

    const blTbody = document.getElementById('blTbody');
    const blEmpty = document.getElementById('blEmpty');

    // Helpers
    function selectedCats(){
      return Array.from(nlCatGrid.querySelectorAll('input[type="checkbox"]:checked')).map(x=>x.value);
    }
    function setSelectedCats(list){
      nlCatGrid.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = list?.includes(cb.value) || false);
    }
    function updateNlPreview(){
      pvSubject.textContent = nlSubject.value.trim() || '[Subject will appear here]';
      pvGreet.textContent = nlContent.value.includes('{{name}}') ? 'Hi Alex,' : 'Hi there,';
      pvContent.textContent = nlContent.value || 'Start writing your post body to see a preview…';
      pvTags.innerHTML = '';
      selectedCats().forEach(c=>{
        const s=document.createElement('span'); s.className='pill'; s.textContent=c; pvTags.appendChild(s);
      });
    }
    nlSubject.addEventListener('input', updateNlPreview);
    nlContent.addEventListener('input', updateNlPreview);

    nlInsertName.addEventListener('click', ()=>{
      const token='{{name}}';
      const t=nlContent, s=t.selectionStart ?? t.value.length, e=t.selectionEnd ?? t.value.length;
      t.value = t.value.slice(0,s) + token + t.value.slice(e);
      t.focus(); t.setSelectionRange(s+token.length, s+token.length);
      updateNlPreview();
    });

    function resetNlEditor(){
      nlSubject.value=''; nlContent.value=''; setSelectedCats([]); pvStatus.textContent='Draft not saved'; updateNlPreview();
    }
    nlClearBtn.onclick = resetNlEditor;

    // Load categories -> /api/categories
    async function loadCategories(){
      try{
        const r = await fetch('/api/categories');
        const cats = await r.json(); // [{id,name}]
        nlCatGrid.innerHTML = cats.map(c=>`
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" value="${c.name}"><span>${c.name}</span>
          </label>`).join('');
        nlCatGrid.addEventListener('change', updateNlPreview);
      }catch(err){ toast('Failed to load categories', true); }
    }

    function validateNewsletter(){
      const subject = nlSubject.value.trim();
      const body = nlContent.value.trim();
      const cats = selectedCats();
      if(!subject || !body){ toast('Subject and body are required', true); return null; }
      return {subject, body, categories: cats};
    }

    // Save draft -> /api/newsletter/create
    async function saveNewsletterDraft(){
      const payload = validateNewsletter(); if(!payload) return;
      payload.status = 'draft';
      try{
        const res = await fetch('/api/newsletter/create',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await res.json();
        if(j.status===1){ toast('Draft saved'); pvStatus.textContent='Draft saved'; resetNlEditor(); }
        else { toast('Save failed: '+(j.error||'error'), true); }
      }catch{ toast('Save failed', true); }
    }
    nlSaveDraftBtn.onclick = saveNewsletterDraft;

    // Publish -> /api/newsletter/publish (also sends email)
    async function publishNewsletter(){
      const payload = validateNewsletter(); if(!payload) return;
      if(!payload.categories.length){ toast('Pick at least one category', true); return; }
      try{
        const res = await fetch('/api/newsletter/publish',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await res.json();
        if(j.status===1){ toast(`Published. Sent: ${j.sent}, Failed: ${j.failed}`); pvStatus.textContent='Published'; resetNlEditor(); }
        else { toast('Publish failed: '+(j.error||'error'), true); }
      }catch{ toast('Publish failed', true); }
    }
    nlPublishBtn.onclick = publishNewsletter;

    // BLOGS
    function excerpt(s){ return (s||'').replace(/\s+/g,' ').slice(0,140); }
    function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    async function fetchBlogs(){
      try{
        const r = await fetch('/api/blogs');
        const posts = await r.json();
        if(!posts.length){ blEmpty.style.display='block'; blTbody.innerHTML=''; return; }
        blEmpty.style.display='none';
        blTbody.innerHTML = posts.map(p=>{
          const when = new Date(p.created_at).toLocaleString();
          return `<tr>
            <td>${escapeHtml(p.title)}</td>
            <td>${escapeHtml(excerpt(p.content))}</td>
            <td>${when}</td>
          </tr>`;
        }).join('');
      }catch{ blEmpty.style.display='block'; blTbody.innerHTML=''; }
    }

    async function publishBlog(){
      const title = blTitle.value.trim();
      const content = blContent.value.trim();
      if(!title || !content){ toast('Title and content are required', true); return; }

      const file = blImage.files && blImage.files[0];
      const send = async (imageData) => {
        try{
          const res = await fetch('/api/blogs',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, content, imageData }) });
          const j = await res.json();
          if(j.status===1){ toast('Blog published'); blTitle.value=''; blContent.value=''; if(blImage) blImage.value=''; fetchBlogs(); }
          else { toast('Publish failed', true); }
        }catch{ toast('Publish failed', true); }
      };

      if(file){
        const reader = new FileReader();
        reader.onload = e => send(e.target.result);
        reader.readAsDataURL(file);
      }else{
        send('');
      }
    }
    blPublishBtn.onclick = publishBlog;

    // init
    loadCategories();
    updateNlPreview();
    fetchBlogs();
  </script>
</body>
</html>
