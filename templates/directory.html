<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Digeon AI - Directory</title>
<link rel="icon" href="/static/images/icon.png" type="image/png">

<link href="styles.css" rel="stylesheet"/>
<script defer="" src="script.js"></script>
  <style>
  /* Dark Modern Theme (keeps your existing structure/IDs) */
  body { background:#0e0f12; margin:0; font-family:Arial,sans-serif; color:#eaeaea; }
  .container { max-width:1200px; margin:0 auto; padding:0 24px; }

  /* Navbar */
  .navbar {
    background: rgba(20,20,25,.9);
    backdrop-filter: blur(8px);
    box-shadow: 0 2px 6px rgba(0,0,0,.6);
    position: sticky; top: 0; z-index: 100; width: 100%;
  }
  .navbar .container {
    display:flex; justify-content:space-between; align-items:center; height:60px;
  }
  .logo img { height:44px; width:auto; border-radius:6px; vertical-align:middle; display:block; }
  .nav-links { list-style:none; display:flex; gap:32px; margin:0; padding:0; align-items:center; }
  .nav-links a {
    text-decoration:none; color:#eaeaea; font-weight:bold; font-size:1.07rem; letter-spacing:.01em;
    border-bottom:2px solid transparent; transition: color .22s, border-bottom .22s;
  }
  .nav-links a:hover { color:#19b6ad; border-bottom-color:#19b6ad; }

  #site-search { display:flex; align-items:center; margin-left:30px; }
  #search-input {
    padding:7px 12px; border:1px solid #333; border-radius:5px 0 0 5px; outline:none; font-size:1rem;
    background:#1a1c20; color:#eaeaea;
  }
  #site-search button {
    padding:7px 18px; border:0; background:#19b6ad; color:#fff; border-radius:0 5px 5px 0;
    cursor:pointer; font-weight:bold; transition:background .15s; font-size:1rem;
  }
  #site-search button:hover { background:#138c86; }

  /* Directory layout */
  .directory-main { display:flex; align-items:flex-start; margin-top:32px; min-height:80vh; }
  .directory-sidebar { width:250px; min-width:180px; margin-right:32px; display:flex; flex-direction:column; gap:16px; }
  .directory-category-btn {
    background: rgba(30,32,38,.85); color:#eaeaea; font-size:1.13rem; border:0; border-radius:10px;
    padding:16px 20px; text-align:left; cursor:pointer; font-weight:500;
    transition: background .18s, color .18s, transform .18s;
  }
  .directory-category-btn.selected { background:#19b6ad; color:#fff; }
  .directory-category-btn:hover:not(.selected) { background:#333; }
  .directory-category-btn:active { transform: translateY(1px); }

  .directory-content { flex:1 1 0; display:flex; flex-direction:column; gap:24px; }
  .agents-grid {
    display:grid; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); gap:20px;
  }
  .agent-card {
    background: rgba(30,32,38,.85); border:1.5px solid #2a2d34; border-radius:10px; padding:18px;
    box-shadow:0 2px 10px rgba(0,0,0,.2); text-align:center; transition: box-shadow .17s, transform .22s;
  }
  .agent-card h3 { margin:0 0 8px; font-size:1.3rem; font-weight:700; color:#fff; }
  .agent-card p { margin:0; color:#ccc; }

    /* Ratings */
  .stars { display:inline-flex; gap:6px; align-items:center; margin-top:10px; }
  .star-btn { border:none; background:none; cursor:pointer; font-size:18px; line-height:1; padding:0; }
  .star-btn[aria-checked="true"] { font-weight:700; }
  .rating-meta { margin-left:8px; font-size:12px; color:#888; }

  .agent-card:hover { transform: translateY(-4px); box-shadow:0 7px 28px rgba(0,0,0,.4); }

  /* Footer */
  footer { background: rgba(20,20,25,.95); padding:20px 0; margin-top:40px; }
  footer .container { text-align:center; }
  footer p { color:#cfd3d7; margin:0; }

  /* Subtle reveal animation */
  .animate { opacity:0; transform: translateY(12px); transition: opacity .6s ease, transform .6s ease; }
  .animate.visible { opacity:1 !important; transform: translateY(0) !important; }

  /* Responsive */
  @media (max-width:950px){
    .navbar .container{ flex-direction:column; height:auto; padding:10px 3vw; gap:12px; }
    .directory-main{ flex-direction:column; }
    .directory-sidebar{ flex-direction:row; flex-wrap:wrap; width:100%; margin-right:0; margin-bottom:22px; gap:10px; justify-content:flex-start; }
  }
  @media (max-width:700px){
    .nav-links{ gap:10px; font-size:.95rem; }
    #site-search{ margin-left:0; }
    .agents-grid{ grid-template-columns:1fr; }
    .directory-sidebar{ gap:7px; }
    .directory-main{ margin-top:18px; }
  }
  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}?v=6">

</head>
<body>
<header>
<nav class="navbar">
<div class="container">
<a class="logo" href="/" style="padding:0;">
<img alt="Digeon.ai logo" src="/static/images/logo.png" style="height:44px;width:auto;vertical-align:middle;border-radius:6px;"/>
</a>
<ul class="nav-links">
<li><a href="newsletter">Newsletter</a></li>
<li><a href="marketplace">Marketplace</a></li>
<li><a href="blog">Blog</a></li>
<li><a href="contact">Contact Us</a></li>
</ul>
<form id="site-search">
<input id="search-input" placeholder="Search..." type="text"/>
<button type="submit">Search</button>
</form>
</div>
</nav>
</header>
<main class="container">
<h1 class="animate" style="margin-top:32px;text-align:center;">AI Tools Directory</h1>
<div class="directory-main">
<nav class="directory-sidebar" id="category-sidebar"></nav>
<section class="directory-content">
  <!-- Toolbar: result count + min rating -->
<div class="toolbar" id="toolbar" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
  <div class="result-count" id="result-count" style="color:#b9c0c7;font-size:.95rem">—</div>
  <label style="color:#b9c0c7;font-size:.92rem">Min rating
    <select id="min-rating" style="background:#101319;color:#eaeaea;border:1px solid #2a2d34;border-radius:8px;padding:6px 8px;margin-left:6px;">
      <option value="0">All</option>
      <option value="1">1★+</option>
      <option value="2">2★+</option>
      <option value="3">3★+</option>
      <option value="4">4★+</option>
      <option value="5">5★</option>
    </select>
  </label>
</div>

<div class="agents-grid" id="agents-list"></div>
</section>
</div>
</main>
<footer>
  <div class="container">
    <p>© 2025 Digeon AI. All rights reserved.</p>
    <!-- Socials (optional) -->
    <div class="footer-social-bar" style="display:flex;justify-content:center;gap:30px;margin-top:20px;">
      <a href="https://x.com/digeonAI" target="_blank" title="X (Twitter)">
        <img src="https://cdn.simpleicons.org/x/FFFFFF" alt="X" style="width:28px;height:28px;opacity:.88;">
      </a>
      <a href="https://www.instagram.com/digeon.ai/" target="_blank" title="Instagram">
        <img src="https://cdn.simpleicons.org/instagram/FFFFFF" alt="Instagram" style="width:28px;height:28px;opacity:.88;">
      </a>
      <a href="https://www.linkedin.com/company/digeon-ai/" target="_blank" title="LinkedIn" style="display:inline-block;">
        <svg xmlns="http://www.w3.org/2000/svg" role="img" width="28" height="28" viewBox="0 0 24 24" fill="#23272A">
          <title>LinkedIn</title>
          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.026-3.037-1.849-3.037-1.853 0-2.136
          1.445-2.136 2.939v5.667H9.354V9h3.414v1.561h.049c.476-.899 1.637-1.849
          3.37-1.849 3.601 0 4.268 2.37 4.268 5.455v6.285zm-16.356-11.41c-1.144
          0-2.067-.926-2.067-2.065 0-1.138.923-2.065 2.067-2.065 1.143 0
          2.066.927 2.066 2.065 0 1.139-.923 2.065-2.066 2.065zm1.778
          11.41H2.313V9h3.556v11.452zM22.225 0H1.771C.792 0 0 .771 0
          1.723v20.549C0 23.229.792 24 1.771 24h20.451C23.2 24 24 23.229 24
          22.271V1.723C24 .771 23.2 0 22.222 0z"/>
        </svg>
      </a>
      <a href="mailto:Digeon.technologies@gmail.com" title="Email Digeon">
        <img src="https://cdn.simpleicons.org/gmail/FFFFFF" alt="Gmail" style="width:28px;height:28px;opacity:.88;">
      </a>
    </div>
  </div>
</footer>


<script>
const sidebar = document.getElementById('category-sidebar');
const agentsList = document.getElementById('agents-list');
let currentCategoryId = null;
let categories = [];

// ---- Rating filter UI handles
const resultCountEl = document.getElementById('result-count');
const minRatingEl   = document.getElementById('min-rating');

// ---- Ratings cache (avoid re-fetching the same tool's rating repeatedly)
const ratingCache = new Map(); // toolId -> {avg,count,user}
async function getToolRating(toolId){
  if (ratingCache.has(toolId)) return ratingCache.get(toolId);
  const data = await fetchRating(toolId);   // uses your existing fetchRating()
  ratingCache.set(toolId, data);
  return data;
}

// ---- Filter by rating (uses user's rating if present; otherwise falls back to avg)
function applyRatingFilter(items){
  const minR = parseInt(minRatingEl?.value || '0', 10);
  if (!minR) return items;
  return items.filter(it => {
    const rc = ratingCache.get(it.id);
    const userVal = rc?.user || 0;
    const avgVal  = rc?.avg  || 0;
    const effective = userVal || avgVal; // prefer user's own rating if exists
    return effective >= minR;
  });
}


function renderCategories() {
  sidebar.innerHTML = '';
  categories.forEach((cat, i) => {
    const btn = document.createElement('button');
    btn.textContent = cat.name;
    btn.className = 'directory-category-btn' + (cat.id === currentCategoryId ? ' selected' : '');
    btn.onclick = () => {
      currentCategoryId = cat.id;
      renderCategories();
      fetchAgents(cat.id);
    };
    sidebar.appendChild(btn);
  });
}

// --- Ratings client ---
async function fetchRating(toolId){
  const r = await fetch(`/api/tools/${toolId}/rating`);
  if (!r.ok) return { avg:0, count:0, user:null };
  return r.json();
}
async function postRating(toolId, value){
  const r = await fetch(`/api/tools/${toolId}/rating`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ value })
  });
  if (r.status === 401) throw new Error('LOGIN_REQUIRED');
  if (!r.ok) throw new Error('BAD_REQUEST');
  return r.json();
}
function mountStars(container, tool){
  container.innerHTML = `
    <div class="stars" role="radiogroup" aria-label="Rate ${tool.name}">
      ${[1,2,3,4,5].map(i=>`
        <button type="button" class="star-btn" data-v="${i}" role="radio" aria-checked="false" aria-label="${i} star">☆</button>
      `).join('')}
      <span class="rating-meta"></span>
    </div>`;
  const btns = [...container.querySelectorAll('.star-btn')];
  const meta = container.querySelector('.rating-meta');

  const paint = (userVal, avg, count) => {
    btns.forEach((b,i)=>{
      const on = i < (userVal||0);
      b.textContent = on ? '★' : '☆';
      b.setAttribute('aria-checked', String(on));
    });
    meta.textContent = count ? `(${avg} • ${count})` : '(no ratings yet)';
  };

  // hydrate
  fetchRating(tool.id).then(({user, avg, count}) => paint(user, avg, count));

  // interactions
  btns.forEach(b=>{
    b.addEventListener('click', async ()=>{
      const v = +b.dataset.v;
      try {
        const {user, avg, count} = await postRating(tool.id, v);
        paint(user, avg, count);
      } catch(e){
        if (e.message === 'LOGIN_REQUIRED') {
          alert('Please sign up / be logged in to rate.');
          // optional redirect: location.href = '/newsletter';
        } else {
          alert('Could not save rating.');
        }
      }
    });
  });
}

function renderAgents(agentList) {
  agentsList.innerHTML = '';
  if (agentList.length === 0) {
    agentsList.innerHTML = `<div style="color:#666;text-align:center;font-size:1.17rem;">No agents found for this category yet.</div>`;
    return;
  }
  for (const ag of agentList) {
    const div = document.createElement('div');
    div.className = 'agent-card';
    div.innerHTML = `
      <h3><a href="${ag.link}" target="_blank" style="color:inherit;text-decoration:none;">${ag.name}</a></h3>
      <p>${ag.desc}</p>
      <div class="rating-slot"></div>
    `;
    agentsList.appendChild(div);

    // mount the stars (requires ag.id from the API)
    const slot = div.querySelector('.rating-slot');
    mountStars(slot, ag);
  }

}

async function fetchCategories() {
  const res = await fetch('/api/categories');
  categories = await res.json();
  if (categories.length > 0) {
    currentCategoryId = categories[0].id;
    renderCategories();
    fetchAgents(currentCategoryId);
  }
}

async function fetchAgents(categoryId) {
  const res = await fetch(`/api/tools?category_id=${categoryId}`);
  const agents = await res.json();

  // Warm the ratings cache in parallel for tools in this category
  await Promise.all(
    agents.map(a => getToolRating(a.id).catch(() => ({avg:0, count:0, user:null})))
  );

  // Apply rating filter and render
  const filtered = applyRatingFilter(agents);
  resultCountEl.textContent = `${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
  renderAgents(filtered);
}


fetchCategories();

minRatingEl?.addEventListener('change', () => {
  if (currentCategoryId) fetchAgents(currentCategoryId);
});

</script>

<script>
document.getElementById("site-search").addEventListener("submit", async function(e) {
  e.preventDefault();
  const query = document.getElementById("search-input").value.trim();
  if (!query) return;

  const res = await fetch(`/api/tool-link?name=${encodeURIComponent(query)}`);
  const data = await res.json();

  if (data.link) {
    window.open(data.link, "_blank");
  } else {
    alert("Tool not found.");
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach((e,i)=>{ if(e.isIntersecting){ setTimeout(()=>e.target.classList.add('visible'), i*120); }});
  },{threshold:.15});

  // Animate the title
  document.querySelectorAll('.animate').forEach(el=>obs.observe(el));

  // When your cards render, mark them for reveal (no change to your fetch code needed)
  const list = document.getElementById('agents-list');
  const mo = new MutationObserver(muts=>{
    muts.forEach(m=>{
      m.addedNodes.forEach(n=>{
        if(n.nodeType===1 && n.classList && n.classList.contains('agent-card')){
          n.classList.add('animate');
          obs.observe(n);
        }
      });
    });
  });
  mo.observe(list, { childList:true });
});
</script>

</body>
</html>
